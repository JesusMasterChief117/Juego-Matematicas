<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Quiz del Búho - Pixel Art Enhanced</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0;
            padding: 0;
            background-color: #0f0f0f;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            font-family: 'Press Start 2P', cursive;
        }

        #game-container {
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.9);
            border: 4px solid #2c3e50;
            border-radius: 4px;
            image-rendering: pixelated;
            /* Crucial para nitidez */
        }
    </style>
    <!-- Cargamos Phaser 3 -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
</head>

<body>

    <div id="game-container"></div>

    <script>
        /**
         * --- CONFIGURACIÓN ---
         */
        const CONFIG = {
            width: 800,
            height: 600,
            pixelSize: 4, // Tamaño base del "píxel" del mundo
            colors: {
                skyTop: 0x2b32b2,
                skyBottom: 0x1488cc,
                sun: 0xffd700,
                mountainFar: 0x3d2c5e,
                mountainMid: 0x5b4b8a,
                mountainNear: 0x2d5a27,
                ground: 0x1e3c1b,
                snow: 0xffffff,
                treeDark: 0x143612,
                treeLight: 0x2d6a28
            }
        };

        /**
         * --- SPRITE DATA (Matrices Pixel Art) ---
         */
        const SPRITE_NORMAL = [
            [0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0],
            [0, 0, 0, 1, 1, 5, 5, 1, 1, 5, 5, 1, 1, 0, 0, 0],
            [0, 0, 1, 1, 5, 2, 2, 5, 5, 2, 2, 5, 1, 1, 0, 0],
            [0, 0, 1, 1, 5, 2, 3, 5, 5, 3, 2, 5, 1, 1, 0, 0],
            [0, 0, 1, 1, 5, 2, 2, 5, 5, 2, 2, 5, 1, 1, 0, 0],
            [0, 0, 1, 1, 1, 5, 5, 1, 1, 5, 5, 1, 1, 1, 0, 0],
            [0, 0, 1, 1, 1, 1, 1, 4, 4, 1, 1, 1, 1, 1, 0, 0],
            [0, 0, 1, 5, 1, 1, 1, 4, 4, 1, 1, 1, 5, 1, 0, 0],
            [0, 0, 5, 5, 5, 1, 1, 1, 1, 1, 1, 5, 5, 5, 0, 0],
            [0, 0, 5, 5, 5, 1, 2, 2, 2, 2, 1, 5, 5, 5, 0, 0],
            [0, 0, 1, 5, 1, 1, 2, 2, 2, 2, 1, 1, 5, 1, 0, 0],
            [0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0],
            [0, 0, 0, 4, 4, 4, 0, 0, 0, 0, 4, 4, 4, 0, 0, 0]
        ];

        const SPRITE_HAPPY = [
            [0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0],
            [0, 0, 1, 1, 1, 5, 5, 1, 1, 5, 5, 1, 1, 1, 0, 0],
            [0, 1, 5, 1, 5, 2, 2, 5, 5, 2, 2, 5, 1, 5, 1, 0],
            [0, 1, 5, 1, 5, 2, 3, 5, 5, 3, 2, 5, 1, 5, 1, 0],
            [0, 0, 1, 1, 5, 2, 2, 5, 5, 2, 2, 5, 1, 1, 0, 0],
            [0, 0, 1, 1, 1, 5, 5, 1, 1, 5, 5, 1, 1, 1, 0, 0],
            [0, 0, 1, 1, 1, 1, 1, 4, 4, 1, 1, 1, 1, 1, 0, 0],
            [0, 0, 1, 1, 1, 1, 1, 4, 4, 1, 1, 1, 1, 1, 0, 0],
            [0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 1, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 1, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0],
            [0, 0, 0, 4, 4, 4, 0, 0, 0, 0, 4, 4, 4, 0, 0, 0]
        ];

        const SPRITE_SAD = [
            [0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0],
            [0, 0, 0, 1, 1, 5, 5, 1, 1, 5, 5, 1, 1, 0, 0, 0],
            [0, 0, 1, 1, 5, 2, 2, 5, 5, 2, 2, 5, 1, 1, 0, 0],
            [0, 0, 1, 1, 5, 2, 2, 5, 5, 2, 2, 5, 1, 1, 0, 0],
            [0, 0, 1, 1, 5, 2, 2, 5, 5, 2, 2, 5, 1, 1, 0, 0],
            [0, 0, 1, 1, 1, 5, 5, 1, 1, 5, 5, 1, 1, 1, 0, 0],
            [0, 0, 1, 1, 1, 1, 1, 4, 4, 1, 1, 1, 1, 1, 0, 0],
            [0, 0, 1, 5, 1, 1, 1, 4, 4, 1, 1, 1, 5, 1, 0, 0],
            [0, 0, 5, 5, 5, 1, 1, 1, 1, 1, 1, 5, 5, 5, 0, 0],
            [0, 0, 5, 5, 5, 1, 2, 2, 2, 2, 1, 5, 5, 5, 0, 0],
            [0, 0, 1, 5, 1, 1, 2, 2, 2, 2, 1, 1, 5, 1, 0, 0],
            [0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0],
            [0, 0, 0, 4, 4, 4, 0, 0, 0, 0, 4, 4, 4, 0, 0, 0]
        ];

        const SPRITE_CLOUD = [
            [0, 0, 0, 1, 1, 1, 0, 0, 0],
            [0, 0, 1, 2, 2, 2, 1, 0, 0],
            [0, 1, 2, 2, 2, 2, 2, 1, 0],
            [1, 2, 2, 2, 2, 2, 2, 2, 1],
            [1, 2, 2, 2, 2, 2, 2, 2, 1],
            [0, 1, 1, 1, 1, 1, 1, 1, 0]
        ];

        const SPRITE_TREE = [
            [0, 0, 0, 1, 0, 0, 0],
            [0, 0, 1, 2, 1, 0, 0],
            [0, 0, 1, 1, 1, 0, 0],
            [0, 1, 1, 1, 1, 1, 0],
            [0, 0, 1, 1, 1, 0, 0],
            [0, 1, 1, 2, 1, 1, 0],
            [1, 1, 1, 1, 1, 1, 1],
            [0, 0, 0, 3, 0, 0, 0]
        ];

        /**
         * --- HELPER: GENERAR TEXTURA DESDE MATRIZ ---
         */
        function generateTextureFromMatrix(scene, key, matrix, pixelSize, paletteOverride = null) {
            const canvas = document.createElement('canvas');
            canvas.width = matrix[0].length * pixelSize;
            canvas.height = matrix.length * pixelSize;
            const ctx = canvas.getContext('2d');

            const defaultColors = {
                1: '#f1c40f', 2: '#ecf0f1', 3: '#2c3e50', 4: '#e67e22', 5: '#f39c12'
            };
            const colors = paletteOverride || defaultColors;

            for (let r = 0; r < matrix.length; r++) {
                for (let c = 0; c < matrix[0].length; c++) {
                    let code = matrix[r][c];
                    if (code === 0 || !colors[code]) continue;
                    ctx.fillStyle = colors[code];
                    ctx.fillRect(c * pixelSize, r * pixelSize, pixelSize, pixelSize);
                }
            }
            scene.textures.addCanvas(key, canvas);
        }

        /**
         * --- ESCENA: BOOT (Generación Assets) ---
         */
        class BootScene extends Phaser.Scene {
            constructor() { super('BootScene'); }

            create() {
                // Búho Colores
                const sadColors = { 1: '#7f8c8d', 2: '#ecf0f1', 3: '#2c3e50', 4: '#95a5a6', 5: '#bdc3c7' };
                generateTextureFromMatrix(this, 'owl_normal', SPRITE_NORMAL, 8);
                generateTextureFromMatrix(this, 'owl_happy', SPRITE_HAPPY, 8);
                generateTextureFromMatrix(this, 'owl_sad', SPRITE_SAD, 8, sadColors);

                // Nube
                generateTextureFromMatrix(this, 'cloud', SPRITE_CLOUD, 8, { 1: 'rgba(255,255,255,0.5)', 2: 'rgba(255,255,255,0.9)' });

                // Arbol
                generateTextureFromMatrix(this, 'tree', SPRITE_TREE, 6, { 1: '#145A32', 2: '#1E8449', 3: '#5D4037' });

                // Confeti
                let g = this.make.graphics({ x: 0, y: 0 });
                g.fillStyle(0xffffff);
                g.fillRect(0, 0, 6, 6);
                g.generateTexture('confetti', 6, 6);

                this.scene.start('MenuScene');
            }
        }

        /**
         * --- MANAGER: FONDO PIXEL ART ---
         * Se encarga de dibujar el entorno complejo
         */
        class BackgroundManager {
            constructor(scene) {
                this.scene = scene;
                this.width = 800;
                this.height = 600;
                this.pixelSize = 4; // Tamaño del "bloque" para montañas
            }

            draw() {
                // 1. Cielo Gradiente
                if (!this.scene.textures.exists('skyGradient')) {
                    let texture = this.scene.textures.createCanvas('skyGradient', 800, 600);
                    let ctx = texture.getContext();
                    let grd = ctx.createLinearGradient(0, 0, 0, 600);
                    grd.addColorStop(0, '#1a2980');
                    grd.addColorStop(1, '#26d0ce');
                    ctx.fillStyle = grd;
                    ctx.fillRect(0, 0, 800, 600);
                    texture.refresh();
                }

                this.scene.add.image(400, 300, 'skyGradient').setDepth(-10);

                // 2. Sol Pixel Art
                this.drawPixelSun(650, 150, 40);

                // 3. Montañas (Capas)
                // Lejana
                this.drawPixelMountain(300, 0.005, 100, CONFIG.colors.mountainFar, false, -5);
                // Media
                this.drawPixelMountain(400, 0.009, 80, CONFIG.colors.mountainMid, true, -4);
                // Cercana
                this.drawPixelMountain(500, 0.015, 60, CONFIG.colors.mountainNear, true, -3);

                // 4. Árboles
                this.scatterTrees(500, 20);
            }

            drawPixelSun(x, y, radius) {
                let g = this.scene.add.graphics();
                g.fillStyle(CONFIG.colors.sun, 1);
                let p = 6; // pixel size for sun
                // Algoritmo simple para círculo pixelado
                for (let r = -radius; r <= radius; r += p) {
                    for (let c = -radius; c <= radius; c += p) {
                        if (r * r + c * c <= radius * radius) {
                            g.fillRect(x + c, y + r, p, p);
                        }
                    }
                }
                g.setDepth(-9);
            }

            drawPixelMountain(baseY, freq, amp, color, snow, depth) {
                let g = this.scene.add.graphics();
                g.fillStyle(color, 1);
                g.setDepth(depth);

                let p = this.pixelSize;

                for (let x = 0; x < this.width; x += p) {
                    // Usamos senos combinados para variar la altura
                    let noise = Math.sin(x * freq) + Math.sin(x * freq * 2.5) * 0.5;
                    let h = noise * amp;
                    let y = baseY + h;

                    // Cuantificar Y a la rejilla de píxeles
                    y = Math.floor(y / p) * p;

                    // Dibujar columna
                    g.fillRect(x, y, p, this.height - y);

                    // Nieve en picos altos
                    if (snow && h < -amp * 0.3) {
                        g.fillStyle(CONFIG.colors.snow, 0.9);
                        g.fillRect(x, y, p, p * 3);
                        g.fillStyle(color, 1); // volver al color montaña
                    }
                }
            }

            scatterTrees(baseY, count) {
                for (let i = 0; i < count; i++) {
                    let x = Phaser.Math.Between(0, 800);
                    let y = Phaser.Math.Between(baseY, 600);
                    // Escalar según Y para pseudo-perspectiva
                    let scale = Phaser.Math.FloatBetween(0.8, 1.5);
                    this.scene.add.image(x, y, 'tree').setOrigin(0.5, 1).setScale(scale).setDepth(-2);
                }
            }
        }

        /**
         * --- ESCENA: MENU ---
         */
        class MenuScene extends Phaser.Scene {
            constructor() { super('MenuScene'); }

            create() {
                // Fondo mejorado
                const bg = new BackgroundManager(this);
                bg.draw();
                this.createClouds();

                // Título con sombra sólida pixelada
                this.add.text(404, 154, 'EL QUIZ DEL\nBÚHO SABIO', {
                    fontFamily: '"Press Start 2P"', fontSize: '40px', color: '#000000', align: 'center'
                }).setOrigin(0.5);
                this.add.text(400, 150, 'EL QUIZ DEL\nBÚHO SABIO', {
                    fontFamily: '"Press Start 2P"', fontSize: '40px', color: '#f1c40f', align: 'center',
                    stroke: '#2c3e50', strokeThickness: 6
                }).setOrigin(0.5);

                // Botones
                this.createButton(400, 350, 'JUGAR', () => this.scene.start('GameScene', { difficulty: this.difficulty }));

                this.difficulty = 'FACIL';
                this.diffButtonText = this.createButton(400, 450, 'MODO: FACIL', () => this.toggleDifficulty());

                // Búho decorativo
                this.add.sprite(150, 500, 'owl_normal').setScale(1.5).setFlipX(true);
            }

            createClouds() {
                this.clouds = [];
                for (let i = 0; i < 5; i++) {
                    let c = this.add.image(Phaser.Math.Between(0, 800), Phaser.Math.Between(50, 200), 'cloud');
                    c.speed = Phaser.Math.FloatBetween(0.2, 0.8);
                    c.setAlpha(0.8).setDepth(-8);
                    this.clouds.push(c);
                }
            }

            update() {
                // Mover nubes
                this.clouds.forEach(c => {
                    c.x += c.speed;
                    if (c.x > 850) c.x = -50;
                });
            }

            createButton(x, y, text, callback) {
                const container = this.add.container(x, y);
                // Botón estilo retro
                const bg = this.add.rectangle(0, 0, 350, 60, 0x2c3e50);
                const borderTop = this.add.rectangle(0, -28, 350, 4, 0xffffff);
                const borderBot = this.add.rectangle(0, 28, 350, 4, 0x000000);

                const txt = this.add.text(0, 0, text, {
                    fontFamily: '"Press Start 2P"', fontSize: '18px', color: '#ffffff'
                }).setOrigin(0.5);

                container.add([bg, borderTop, borderBot, txt]);
                container.setSize(350, 60);
                container.setInteractive({ useHandCursor: true });

                container.on('pointerover', () => { bg.setFillStyle(0xf1c40f); txt.setColor('#2c3e50'); });
                container.on('pointerout', () => { bg.setFillStyle(0x2c3e50); txt.setColor('#ffffff'); });
                container.on('pointerdown', () => { container.y += 4; });
                container.on('pointerup', () => { container.y -= 4; callback(); });

                return txt;
            }

            toggleDifficulty() {
                if (this.difficulty === 'FACIL') { this.difficulty = 'MEDIO'; this.diffButtonText.setText('MODO: MEDIO'); this.diffButtonText.setColor('#f1c40f'); }
                else if (this.difficulty === 'MEDIO') { this.difficulty = 'DIFICIL'; this.diffButtonText.setText('MODO: DIFICIL'); this.diffButtonText.setColor('#e74c3c'); }
                else { this.difficulty = 'FACIL'; this.diffButtonText.setText('MODO: FACIL'); this.diffButtonText.setColor('#ffffff'); }
            }
        }

        /**
         * --- ESCENA: GAME ---
         */
        class GameScene extends Phaser.Scene {
            constructor() { super('GameScene'); }

            init(data) {
                this.difficulty = data.difficulty || 'FACIL';
                this.score = 0;
                this.lives = 3;
                this.maxTime = this.difficulty === 'DIFICIL' ? 6000 : (this.difficulty === 'MEDIO' ? 10000 : 15000);
                this.timeLeft = this.maxTime;
                this.timerRunning = false;
            }

            create() {
                // Fondo
                const bg = new BackgroundManager(this);
                bg.draw();
                this.createClouds();

                // UI
                this.createUI();

                // Personaje Búho (Depth 5 para estar sobre el podio)
                this.owl = this.add.sprite(400, 380, 'owl_normal').setScale(1);
                this.owl.setDepth(5);

                this.tweens.add({
                    targets: this.owl, y: '+=5', duration: 1000, yoyo: true, repeat: -1, ease: 'Sine.easeInOut'
                });

                // Podio Pixel Art (Depth 1 para estar detrás del búho y la UI)
                this.drawPixelPodium(400, 440);

                // Partículas (Depth 20 para estar encima de todo)
                this.particles = this.add.particles(0, 0, 'confetti', {
                    speed: { min: 200, max: 400 },
                    angle: { min: 220, max: 320 },
                    gravityY: 500, lifespan: 2000,
                    tint: [0xe74c3c, 0xf1c40f, 0x2ecc71, 0x3498db], emitting: false
                });
                this.particles.setDepth(20);

                this.nextTurn();
            }

            createClouds() {
                this.clouds = [];
                for (let i = 0; i < 5; i++) {
                    let c = this.add.image(Phaser.Math.Between(0, 800), Phaser.Math.Between(50, 200), 'cloud');
                    c.speed = Phaser.Math.FloatBetween(0.1, 0.4);
                    c.setAlpha(0.8).setDepth(-8);
                    this.clouds.push(c);
                }
            }

            drawPixelPodium(x, y) {
                let g = this.add.graphics();
                g.setDepth(1); // FIX: Asignamos Depth 1 explícito al podio

                // Tronco/Base
                g.fillStyle(0x5D4037);
                g.fillRect(x - 60, y, 120, 200);

                // Detalles madera
                g.fillStyle(0x3E2723);
                g.fillRect(x - 50, y + 20, 10, 80);
                g.fillRect(x + 20, y + 50, 10, 60);

                // Borde superior
                g.fillStyle(0x8D6E63);
                g.fillRect(x - 65, y, 130, 10);
            }

            update(time, delta) {
                // Nubes
                this.clouds.forEach(c => {
                    c.x += c.speed;
                    if (c.x > 850) c.x = -50;
                });

                if (this.timerRunning) {
                    this.timeLeft -= delta;
                    let pct = Math.max(0, this.timeLeft / this.maxTime);
                    this.timeBar.width = 200 * pct;
                    if (pct < 0.3) this.timeBar.fillColor = 0xe74c3c;
                    else this.timeBar.fillColor = 0x2ecc71;
                    if (this.timeLeft <= 0) this.handleWrongAnswer(null);
                }
            }

            createUI() {
                // FIX: Asignamos Depth 10 a toda la UI para que siempre esté al frente

                // Panel HUD Semitransparente
                let hudBg = this.add.rectangle(400, 30, 800, 60, 0x000000, 0.6).setDepth(10);

                this.scoreText = this.add.text(20, 20, 'PTS: 0', { fontFamily: '"Press Start 2P"', fontSize: '16px' }).setDepth(10);
                this.livesText = this.add.text(780, 20, '❤❤❤', { fontFamily: '"Press Start 2P"', fontSize: '16px', color: '#e74c3c' }).setOrigin(1, 0).setDepth(10);

                // Barra Tiempo
                this.add.text(400, 10, 'TIEMPO', { fontFamily: '"Press Start 2P"', fontSize: '10px' }).setOrigin(0.5).setDepth(10);
                this.add.rectangle(400, 35, 204, 24, 0xffffff).setDepth(10);
                this.add.rectangle(400, 35, 200, 20, 0x000000).setDepth(10);
                this.timeBar = this.add.rectangle(300, 35, 200, 20, 0x2ecc71).setOrigin(0, 0.5).setDepth(10);

                // Globo Pregunta
                this.bubbleContainer = this.add.container(400, 150);
                this.bubbleContainer.setDepth(10); // UI Depth alto

                let bBg = this.add.rectangle(0, 0, 300, 100, 0xffffff).setStrokeStyle(4, 0x2c3e50);
                let bTri = this.add.triangle(0, 65, 0, 0, 20, 0, 10, 20, 0xffffff).setStrokeStyle(4, 0x2c3e50);

                this.questionText = this.add.text(0, 0, '...', {
                    fontFamily: '"Press Start 2P"', fontSize: '28px', color: '#2c3e50', align: 'center'
                }).setOrigin(0.5);

                this.bubbleContainer.add([bBg, bTri, this.questionText]);
                this.tweens.add({ targets: this.bubbleContainer, y: '+=10', duration: 2000, yoyo: true, repeat: -1, ease: 'Sine.easeInOut' });

                // Respuestas
                this.answersGroup = [];
                for (let i = 0; i < 3; i++) this.answersGroup.push(this.createAnswerButton(i));
            }

            createAnswerButton(index) {
                const x = [200, 400, 600][index];
                const y = 550;
                let container = this.add.container(x, y);

                // FIX: Asignamos Depth 10 al contenedor del botón para que aparezca SOBRE el podio
                container.setDepth(10);

                let bg = this.add.rectangle(0, 0, 180, 60, 0x3498db);
                // Borde "3D" pixel art
                let borderB = this.add.rectangle(0, 28, 180, 4, 0x1f618d);
                let borderR = this.add.rectangle(88, 0, 4, 60, 0x1f618d);

                let txt = this.add.text(0, 0, '0', { fontFamily: '"Press Start 2P"', fontSize: '20px' }).setOrigin(0.5);

                container.add([bg, borderB, borderR, txt]);
                container.setSize(180, 60);
                container.setInteractive({ useHandCursor: true });

                container.bg = bg;
                container.txt = txt;
                container.val = 0;

                container.on('pointerover', () => { if (this.inputEnabled) bg.fillColor = 0x5dade2; });
                container.on('pointerout', () => { if (this.inputEnabled) bg.fillColor = 0x3498db; });
                container.on('pointerdown', () => { container.y += 4; });
                container.on('pointerup', () => { container.y -= 4; this.checkAnswer(container); });

                return container;
            }

            nextTurn() {
                this.generateQuestion();
                this.inputEnabled = true;
                this.timeLeft = this.maxTime;
                this.timerRunning = true;
                this.answersGroup.forEach(btn => btn.bg.fillColor = 0x3498db);
                this.owl.setTexture('owl_normal');
            }

            generateQuestion() {
                let limit = this.difficulty === 'FACIL' ? 10 : (this.difficulty === 'MEDIO' ? 20 : 50);
                let op = Phaser.Math.RND.pick(['+', '-']);
                let a = Phaser.Math.Between(1, limit);
                let b = Phaser.Math.Between(1, limit);
                if (op === '-' && b > a) [a, b] = [b, a];
                let ans = op === '+' ? a + b : a - b;
                this.currentAnswer = ans;
                this.questionText.setText(`${a} ${op} ${b}`);

                let opts = new Set([ans]);
                while (opts.size < 3) opts.add(ans + Phaser.Math.Between(-5, 5));
                let optsArr = Array.from(opts);
                // Si se generan falsos iguales a la respuesta, asegurar diferencia
                if (optsArr.length < 3) optsArr.push(ans + 10);
                if (optsArr.length < 3) optsArr.push(ans - 10);

                Phaser.Utils.Array.Shuffle(optsArr);
                this.answersGroup.forEach((btn, i) => {
                    btn.val = optsArr[i];
                    btn.txt.setText(optsArr[i]);
                });
            }

            checkAnswer(btn) {
                if (!this.inputEnabled) return;
                this.inputEnabled = false;
                this.timerRunning = false;

                if (btn.val === this.currentAnswer) {
                    this.score += 100;
                    this.scoreText.setText('PTS: ' + this.score);
                    btn.bg.fillColor = 0x2ecc71;
                    this.owl.setTexture('owl_happy');
                    this.tweens.add({ targets: this.owl, y: '-=30', duration: 300, yoyo: true });
                    this.particles.emitParticleAt(this.owl.x, this.owl.y - 50, 50);
                    this.time.delayedCall(1500, () => this.nextTurn());
                } else {
                    this.handleWrongAnswer(btn);
                }
            }

            handleWrongAnswer(btn) {
                this.inputEnabled = false;
                this.timerRunning = false;
                this.lives--;
                this.livesText.setText('❤'.repeat(this.lives));
                if (btn) btn.bg.fillColor = 0xe74c3c;
                this.owl.setTexture('owl_sad');
                this.cameras.main.shake(500, 0.01);

                if (this.lives <= 0) {
                    this.time.delayedCall(1500, () => this.scene.start('GameOverScene', { score: this.score }));
                } else {
                    this.time.delayedCall(1500, () => this.nextTurn());
                }
            }
        }

        /**
         * --- ESCENA: GAME OVER ---
         */
        class GameOverScene extends Phaser.Scene {
            constructor() { super('GameOverScene'); }
            init(data) { this.score = data.score; }
            create() {
                // Fondo oscuro con scanlines
                this.add.rectangle(400, 300, 800, 600, 0x000000, 0.9);
                for (let i = 0; i < 600; i += 4) this.add.rectangle(400, i, 800, 1, 0xffffff, 0.1);

                this.add.text(400, 200, 'GAME OVER', { fontFamily: '"Press Start 2P"', fontSize: '50px', color: '#e74c3c' }).setOrigin(0.5);
                this.add.text(400, 300, 'PUNTUACIÓN: ' + this.score, { fontFamily: '"Press Start 2P"', fontSize: '20px', color: '#f1c40f' }).setOrigin(0.5);

                let btn = this.add.text(400, 450, '> REINTENTAR <', {
                    fontFamily: '"Press Start 2P"', fontSize: '20px', color: '#ffffff'
                }).setOrigin(0.5).setInteractive({ useHandCursor: true });

                this.tweens.add({ targets: btn, alpha: 0.5, duration: 500, yoyo: true, repeat: -1 });
                btn.on('pointerdown', () => this.scene.start('MenuScene'));
            }
        }

        const config = {
            type: Phaser.AUTO,
            parent: 'game-container',
            width: 800,
            height: 600,
            backgroundColor: '#0f0f0f',
            pixelArt: true,
            scene: [BootScene, MenuScene, GameScene, GameOverScene]
        };

        const game = new Phaser.Game(config);

    </script>
</body>

</html>
